# postgwas/flames/clis/cli_pipeline.py

from __future__ import annotations
import argparse
from rich.console import Console
from rich_argparse import ArgumentDefaultsRichHelpFormatter

from postgwas.utils.main import (
    validate_path,
    validate_plink_prefix,
)


# ---------------------------------------------------------
# EXECUTION FUNCTION
# ---------------------------------------------------------
def run_flames_pipeline(args):
    console = Console()
    console.rule("[bold magenta]FLAMES — Pipeline Mode[/bold magenta]")
    console.print(vars(args))


# ---------------------------------------------------------
# PIPELINE SUBPARSER
# ---------------------------------------------------------
def add_pipeline_mode(subparsers, parent):
    """
    FLAMES full multi-stage pipeline:
      • SuSiE Bayesian fine-mapping
      • MAGMA gene-level association
      • PoPS gene prioritisation
      • FLAMES ML effector-gene modelling

    Inherits:
      → Global Settings
      → Model Options
    """

    p = subparsers.add_parser(
        "pipeline",
        help="Full FLAMES workflow: VCF → MAGMA → SuSiE → PoPS → ML.",
        description=(
            "[bold cyan]PIPELINE MODE[/bold cyan]\n\n"
            "Runs the full FLAMES workflow:\n"
            "  1) MAGMA → gene-level statistics\n"
            "  2) SuSiE → Bayesian fine-mapping\n"
            "  3) PoPS → gene prioritisation\n"
            "  4) FLAMES → ML effector-gene prediction"
        ),
        formatter_class=ArgumentDefaultsRichHelpFormatter,
        add_help=False,           # custom -h
        parents=[parent],         # inherit Global + Model options
    )

    # Subparser-level help
    p.add_argument(
        "-h", "--help",
        action="store_true",
        help="Show help message and exit."
    )

    # -----------------------------------------------------
    # 1. GWAS INPUT
    # -----------------------------------------------------
    gwas = p.add_argument_group("1. GWAS Input")

    gwas.add_argument(
        "--vcf",
        type=validate_path(must_exist=True, must_be_file=True,must_not_be_empty=True,allowed_suffixes=['.vcf','.vcf.gz']),
        help="QC passed GWAS summary statistics VCF file. It [bold yellow]must be generated by postgwas harmonisation module[/bold yellow]: [bold magenta]Required[/bold magenta]",
        metavar=""
    )

    gwas.add_argument(
        "--ld-ref",
        type=validate_plink_prefix,
        dest="ld_ref_panel",
        metavar=" ",
        help=(
            "PLINK binary file prefix (no .bed/.bim/.fam extension).\n"
            "— must match GWAS ancestry and genome build.\n\n"
            "[bold cyan]Example:[/bold cyan] --ld-ref-panel /data/ref/1000G_EUR [bold magenta]Required[/bold magenta]"
        )
    )

    # -----------------------------------------------------
    # 2. MAGMA SETTINGS
    # -----------------------------------------------------
    magma = p.add_argument_group("2. MAGMA Settings")

    magma.add_argument(
        "--gene_loc",
        type=validate_path(must_exist=True, must_be_file=True,allowed_suffixes=['.loc'],must_not_be_empty=True),
        help="MAGMA gene location file (.loc). First column should be ensembl gene ID. [bold magenta]Required[/bold magenta]",
        metavar=""
    )

    magma.add_argument(
        "--window_upstream",
        type=int,
        default=35,
        help="Upstream window size (kb).",
        metavar=""
    )

    magma.add_argument(
        "--window_downstream",
        type=int,
        default=10,
        help="Downstream window size (kb).",
        metavar=""
    )

    magma.add_argument(
        "--magma_exe",
        type=str,
        help="Path to MAGMA executable (if not in PATH).",
        metavar=""
    )
    
    magma.add_argument(
        "--gene_model",
        choices=["snp-wise=mean", "snp-wise=top", "snp-wise=all"],
        default="snp-wise=mean",
        metavar="",
        help=(
            "MAGMA gene model for combining SNP statistics into gene scores. "
            "Choices: snp-wise=mean, snp-wise=top, snp-wise=all"
        )
    )

    magma.add_argument(
        "--covar_file",
        metavar="",
        type=validate_path(must_exist=True, must_be_file=True,allowed_suffixes=['log2TPM.txt','log2TPM.txt.gz'],must_not_be_empty=True),
        help=(
            "MAGMA covariate file. For FLAMES analysis, we recommend using "
            "the GTEx v8 tissue expression covariate file available on FLAMES:\n"
            " https://github.com/Marijn-Schipper/FLAMES.  [bold magenta]Required[/bold magenta]"
        )
    )


    # -----------------------------------------------------
    # 3. SuSiE FINE-MAPPING
    # -----------------------------------------------------
    susie = p.add_argument_group("3. SuSiE Fine-Mapping")

    susie.add_argument(
        "--susie_L",
        type=int,
        default=10,
        help="Maximum number of credible sets per locus.",
        metavar=""
    )

    susie.add_argument(
        "--susie_min_pip",
        type=float,
        default=0.01,
        help="Minimum posterior inclusion probability (PIP).",
        metavar=""
    )

    susie.add_argument(
        "--skip_mhc",
        action="store_true",
        help="Skip the extended MHC region."
    )
    
    # -----------------------------------------------------
    # 4. PoPS SETTINGS
    # -----------------------------------------------------
    pops = p.add_argument_group("4. PoPS Settings")

    pops.add_argument(
        "--gene_annot",
        type=validate_path(must_exist=True, must_be_file=True),
        help="PoPS gene annotation file (must include ENSGID/CHR/TSS).",
        metavar=""
    )

    pops.add_argument(
        "--feature_mat_prefix",
        type=str,
        help="Prefix for PoPS feature matrix chunk files.",
        metavar=""
    )

    pops.add_argument(
        "--pops_cov",
        type=validate_path(must_exist=True, must_be_file=True),
        help="Optional precomputed PoPS covariance matrix (.npz).",
        metavar=""
    )
