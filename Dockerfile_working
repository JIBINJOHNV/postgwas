# =====================================================================
# Base image
# =====================================================================
FROM mambaorg/micromamba:1.4.2

USER root

# =====================================================================
# System-level dependencies
# =====================================================================
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        gcc g++ make wget git bzip2 \
        libcurl4-openssl-dev libsuitesparse-dev \
        zlib1g-dev libbz2-dev liblzma-dev \
        ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# =====================================================================
# Create Conda environment
# =====================================================================
COPY environment.yml /tmp/environment.yml
ARG MAMBA_ENV_NAME=postgwas

RUN micromamba create -y -n ${MAMBA_ENV_NAME} -f /tmp/environment.yml && \
    micromamba clean --all --yes

# =====================================================================
# Auto-activate postgwas env for interactive users
# =====================================================================
RUN sed -i 's/micromamba activate base/micromamba activate postgwas/g' /etc/skel/.bashrc

# =====================================================================
# Execute further steps inside the postgwas environment
# =====================================================================
SHELL ["micromamba", "run", "-n", "postgwas", "/bin/bash", "-c"]

# =====================================================================
# Build HTSlib + BCFtools + Freeseek Plugins
# =====================================================================
WORKDIR /opt/tools

RUN wget https://github.com/samtools/bcftools/releases/download/1.22/bcftools-1.22.tar.bz2 && \
    wget https://github.com/samtools/htslib/releases/download/1.22/htslib-1.22.tar.bz2 && \
    tar -xvjf bcftools-1.22.tar.bz2 && \
    tar -xvjf htslib-1.22.tar.bz2

# Build HTSlib
WORKDIR /opt/tools/htslib-1.22
RUN ./configure --enable-libcurl --prefix=/usr/local && \
    make -j && make install

# Install Freeseek plugins
WORKDIR /opt/tools/bcftools-1.22/plugins
RUN wget http://raw.githubusercontent.com/freeseek/score/master/score.c && \
    wget http://raw.githubusercontent.com/freeseek/score/master/score.h && \
    wget http://raw.githubusercontent.com/freeseek/score/master/munge.c && \
    wget http://raw.githubusercontent.com/freeseek/score/master/liftover.c && \
    wget http://raw.githubusercontent.com/freeseek/score/master/metal.c && \
    wget http://raw.githubusercontent.com/freeseek/score/master/blup.c && \
    wget http://raw.githubusercontent.com/freeseek/score/master/pgs.c && \
    wget http://raw.githubusercontent.com/freeseek/score/master/pgs.mk

# Patch pgs.c for SuiteSparse 7 compatibility
WORKDIR /opt/tools/bcftools-1.22
RUN sed -i '2254s/^/\/\//' plugins/pgs.c && \
    sed -i '2255s/^/\/\//' plugins/pgs.c

# Build bcftools
RUN ./configure \
        --prefix=/usr/local \
        --with-htslib=/opt/tools/htslib-1.22 \
        CPPFLAGS="-I/usr/include/suitesparse" \
        CFLAGS="-I/usr/include/suitesparse" && \
    make -j && make install

# =====================================================================
# Install PostGWAS (local source)
# =====================================================================
WORKDIR /opt/postgwas
COPY . /opt/postgwas

# Install MAGMA binary
RUN chmod +x magma/magma && mv magma/magma /usr/local/bin/magma

# Install PostGWAS WITHOUT dependencies (environment.yml handles deps)
RUN pip install --upgrade pip && \
    pip install --no-deps --no-cache-dir -e .

# =====================================================================
# Runtime user
# =====================================================================
USER root
RUN useradd -m pguser
USER pguser

# =====================================================================
# Entry point
# =====================================================================
ENTRYPOINT ["micromamba", "run", "-n", "postgwas"]
CMD ["postgwas", "--help"]
